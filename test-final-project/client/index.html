<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infinite Canvas</title>

    <style>
      a {
        cursor: pointer;
      }
      #top-bar {
        position: fixed;
      }
      #canvas-wrapper {
        position: fixed;
      }
      #canvas-wrapper > * {
        position: absolute;
      }
      html,
      body {
        /* overflow: hidden; */
        width: 100%;
        height: 100%;
        margin: 0;

        /* Prevent document pinch-zoom & touch-hold-to-highlight */
        touch-action: none;

        -webkit-touch-callout: none;
        /* iOS Safari */
        /* -webkit-user-select: none; */
        /* Safari */
        -khtml-user-select: none;
        /* Konqueror HTML */
        -moz-user-select: none;
        /* Old versions of Firefox */
        -ms-user-select: none;
        /* Internet Explorer/Edge */
        /* user-select: none; */
        /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
      }
    </style>
  </head>

  <body>
    <div id="canvas-wrapper">
      <div style="top: 300px; left: 20px">testDiv</div>
      <!-- <div style="border: 2px solid black; top: 0; left: 0px; width:50%; height: 50%">widthDIV</div> -->

      <div style="top: 720px; left: 1280px">MIDDLE DIV</div>
    </div>
    <div id="top-bar">
      <a href="./canvas.html" style="top: 0; left: 0">change to canvas</a>
      <a href="./dragndrop.html">drag and drop</a>
    </div>

    <script>
      // todo! move EVERYTHING by percentages

      // get our canvas element
      const canvas = document.querySelector('#canvas-wrapper');
      const $topBar = document.querySelector('#top-bar');
      const html = document.querySelector('html');
      const context = {}; //canvas.getContext("2d");r

      $topBar.style.top = '0px';

      // disable right clicking
      document.oncontextmenu = function () {
        return false;
      };

      // list of all strokes drawn
      const drawings = [];
      const elements = [];

      // coordinates of our cursor
      let cursorX;
      let cursorY;
      let prevCursorX;
      let prevCursorY;

      // distance from origin
      let offsetX = 0;
      let offsetY = 0;

      // zoom amount
      let scale = 1;

      // convert coordinates
      // these functions return values relative to the window
      function toScreenX(xTrue) {
        return (xTrue + offsetX) * scale;
      }
      function toScreenY(yTrue) {
        return (yTrue + offsetY) * scale;
      }

      //essentially the absolute positions, values below are where they are relative to the 'camera' location
      function toTrueX(xScreen) {
        return xScreen / scale - offsetX;
      }
      function toTrueY(yScreen) {
        return yScreen / scale - offsetY;
      }
      function trueHeight() {
        // const documentHeight = Math.max(
        //   document.body.scrollHeight,
        //   document.body.offsetHeight,
        //   document.documentElement.clientHeight,
        //   document.documentElement.scrollHeight,
        //   document.documentElement.offsetHeight
        // );
        // return documentHeight / scale;
        return canvas.offsetHeight / scale;
      }
      function trueWidth() {
        // const documentWidth = Math.max(
        //   document.body.scrollWidth,
        //   document.body.offsetWidth,
        //   document.documentElement.clientWidth,
        //   document.documentElement.scrollWidth,
        //   document.documentElement.offsetWidth
        // );
        // return documentWidth / scale;
        // return canvas.clientWidth / scale;
        return canvas.offsetWidth / scale;
      }

      function redrawCanvas() {
        // set the canvas to the size of the window
        canvas.style.width = '100%'; //document.body.clientWidth;
        canvas.style.height = '100%'; //document.body.clientHeight;
        const elements$ = canvas.querySelectorAll('*');
        for (const element of elements$) {
          element.style.transform = `scale(${scale})`;
          element.style.left =
            parseFloat(element.dataset.offsetX) + offsetX + 'px';
          element.style.top =
            parseFloat(element.dataset.offsetY) + offsetY + 'px';
        }
      }
      redrawCanvas();

      const elements$ = canvas.querySelectorAll('*');
      console.log(elements$);
      for (const element of elements$) {
        element.style.transform = `scale(${scale})`;
        element.dataset.offsetX = element.style.left;
        element.dataset.offsetY = element.style.top;
      }
      // if the window changes size, redraw the canvas
      window.addEventListener('resize', (event) => {
        redrawCanvas();
      });

      // Mouse Event Handlers
      html.addEventListener('mousedown', onMouseDown);
      html.addEventListener('mouseup', onMouseUp, false);
      html.addEventListener('mouseout', onMouseUp, false);
      html.addEventListener('mousemove', onMouseMove, false);
      html.addEventListener('wheel', onMouseWheel, false);

      // Touch Event Handlers
      html.addEventListener('touchstart', onTouchStart);
      html.addEventListener('touchend', onTouchEnd);
      html.addEventListener('touchcancel', onTouchEnd);
      html.addEventListener('touchmove', onTouchMove);

      // mouse functions
      let leftMouseDown = false;
      let rightMouseDown = false;
      function onMouseDown(event) {
        // detect left clicks
        if (event.button == 0) {
          leftMouseDown = true;
          rightMouseDown = false;
        }
        // detect right clicks
        if (event.button == 2) {
          rightMouseDown = true;
          leftMouseDown = false;
        }

        // update the cursor coordinates
        cursorX = event.pageX;
        cursorY = event.pageY;
        prevCursorX = event.pageX;
        prevCursorY = event.pageY;
      }
      function onMouseMove(event) {
        // get mouse position

        const rect = event.target.getBoundingClientRect();

        cursorX = event.clientX - rect.left; //x position within the element.
        cursorY = event.clientY - rect.top; //y position within the element.
        const scaledX = toTrueX(cursorX);
        const scaledY = toTrueY(cursorY);
        const prevScaledX = toTrueX(prevCursorX);
        const prevScaledY = toTrueY(prevCursorY);

        if (leftMouseDown) {
        }
        if (rightMouseDown) {
          // move the screen
          offsetX += (cursorX - prevCursorX) / scale;
          offsetY += (cursorY - prevCursorY) / scale;
          redrawCanvas();
        }
        prevCursorX = cursorX;
        prevCursorY = cursorY;
      }
      function onMouseUp() {
        // context.save()
        leftMouseDown = false;
        rightMouseDown = false;
      }

      function getWindowOverflow() {
        const windowHeight =
          window.innerHeight || document.documentElement.clientHeight;

        const documentHeight = Math.max(
          document.body.scrollHeight,
          document.body.offsetHeight,
          document.documentElement.clientHeight,
          document.documentElement.scrollHeight,
          document.documentElement.offsetHeight
        );

        const windowWidth =
          window.innerWidth || document.documentElement.clientWidth;
        const documentWidth = Math.max(
          document.body.scrollWidth,
          document.body.offsetWidth,
          document.documentElement.clientWidth,
          document.documentElement.scrollWidth,
          document.documentElement.offsetWidth
        );
        return [
          Math.max(0, documentHeight - windowHeight),
          Math.max(0, documentWidth - windowHeight),
        ];
      }

      function onMouseWheel(event) {
        // const deltaY = event.deltaY;
        // const scaleAmount = -deltaY / 500;
        // const initialScale = scale;

        // // Get the cursor position relative to the canvas
        // const cursorX = event.pageX - canvas.getBoundingClientRect().left;
        // const cursorY = event.pageY - canvas.getBoundingClientRect().top;

        // // Calculate how much we need to zoom
        // scale = scale * (1 + scaleAmount);

        // // Get the relative position of the cursor
        // const cursorRatioX = cursorX / canvas.clientWidth;
        // const cursorRatioY = cursorY / canvas.clientHeight;

        // // Calculate the amounts zoomed from each edge of the screen
        // const unitsZoomedX = trueWidth() * (initialScale - scale);
        // const unitsZoomedY = trueHeight() * (initialScale - scale);

        // const unitsAddLeft = unitsZoomedX * cursorRatioX;
        // const unitsAddTop = unitsZoomedY * cursorRatioY;

        // // Adjust offsetX and offsetY based on the cursor position
        // offsetX += unitsAddLeft;
        // offsetY += unitsAddTop;

        // const deltaY = event.deltaY;
        // const scaleAmount = -deltaY / 500;
        // const initialScale = scale;

        // // Zoom the page based on where the cursor is
        // const cursorX = event.pageX;
        // const cursorY = event.pageY;

        // // Calculate how much we need to zoom
        // scale = scale * (1 + scaleAmount);

        // // Get the relative position of the cursor
        // const cursorRatioX = cursorX / canvas.clientWidth;
        // const cursorRatioY = cursorY / canvas.clientHeight;

        // // Adjust offsetX and offsetY based on the cursor position and zoom amount
        // offsetX = cursorRatioX * (initialScale - scale) + offsetX * scale;
        // offsetY = cursorRatioY * (initialScale - scale) + offsetY * scale;

        const deltaY = event.deltaY; // scroll amount
        console.log('deltaY', deltaY);
        const scaleAmount = -deltaY / 500;
        const initialScale = scale;
        scale = scale * (1 + scaleAmount);

        // zoom the page based on where the cursor is
        console.log('pagex', event.pageX);
        var distX = event.pageX / trueWidth(); //percentage of the screen to the right
        var distY = event.pageY / trueHeight();

        // calculate how much we need to zoom
        const [xOverflow, yOverflow] = getWindowOverflow();
        console.log('X', xOverflow);
        console.log('Y', yOverflow);
        const unitsZoomedX = trueWidth() * scaleAmount;
        const unitsZoomedY = trueHeight() * scaleAmount;

        const unitsAddLeft = unitsZoomedX * distX;
        const unitsAddTop = unitsZoomedY * distY;
        console.log('left', unitsAddLeft);
        offsetX = unitsAddLeft;
        offsetY = unitsAddTop;

        redrawCanvas();
      }

      // touch functions
      const prevTouches = [null, null]; // up to 2 touches
      let singleTouch = false;
      let doubleTouch = false;
      function onTouchStart(event) {
        if (event.touches.length == 1) {
          singleTouch = true;
          doubleTouch = false;
        }
        if (event.touches.length >= 2) {
          singleTouch = false;
          doubleTouch = true;
        }

        // store the last touches
        prevTouches[0] = event.touches[0];
        prevTouches[1] = event.touches[1];
      }
      function onTouchMove(event) {
        // get first touch coordinates
        const touch0X = event.touches[0].pageX;
        const touch0Y = event.touches[0].pageY;
        const prevTouch0X = prevTouches[0].pageX;
        const prevTouch0Y = prevTouches[0].pageY;

        const scaledX = toTrueX(touch0X);
        const scaledY = toTrueY(touch0Y);
        const prevScaledX = toTrueX(prevTouch0X);
        const prevScaledY = toTrueY(prevTouch0Y);

        if (singleTouch) {
        }

        if (doubleTouch) {
          // get second touch coordinates
          const touch1X = event.touches[1].pageX;
          const touch1Y = event.touches[1].pageY;
          const prevTouch1X = prevTouches[1].pageX;
          const prevTouch1Y = prevTouches[1].pageY;

          // get midpoints
          const midX = (touch0X + touch1X) / 2;
          const midY = (touch0Y + touch1Y) / 2;
          const prevMidX = (prevTouch0X + prevTouch1X) / 2;
          const prevMidY = (prevTouch0Y + prevTouch1Y) / 2;

          // calculate the distances between the touches
          const hypot = Math.sqrt(
            Math.pow(touch0X - touch1X, 2) + Math.pow(touch0Y - touch1Y, 2)
          );
          const prevHypot = Math.sqrt(
            Math.pow(prevTouch0X - prevTouch1X, 2) +
              Math.pow(prevTouch0Y - prevTouch1Y, 2)
          );

          // calculate the screen scale change
          var zoomAmount = hypot / prevHypot;
          scale = scale * zoomAmount;
          const scaleAmount = 1 - zoomAmount;

          // calculate how many pixels the midpoints have moved in the x and y direction
          const panX = midX - prevMidX;
          const panY = midY - prevMidY;
          // scale this movement based on the zoom level
          offsetX += panX / scale;
          offsetY += panY / scale;

          // Get the relative position of the middle of the zoom.
          // 0, 0 would be top left.
          // 0, 1 would be top right etc.
          var zoomRatioX = midX / canvas.offsetWidth;
          var zoomRatioY = midY / canvas.offsetHeight;

          // calculate the amounts zoomed from each edge of the screen
          const unitsZoomedX = trueWidth() * scaleAmount;
          const unitsZoomedY = trueHeight() * scaleAmount;

          const unitsAddLeft = unitsZoomedX * zoomRatioX;
          const unitsAddTop = unitsZoomedY * zoomRatioY;

          offsetX += unitsAddLeft;
          offsetY += unitsAddTop;

          redrawCanvas();
        }
        prevTouches[0] = event.touches[0];
        prevTouches[1] = event.touches[1];
      }
      function onTouchEnd(event) {
        singleTouch = false;
        doubleTouch = false;
      }
    </script>
  </body>
</html>
